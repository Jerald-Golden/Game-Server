<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width" />
    <title>Server-Control</title>
    <style>
        body {
            font-family: Tahoma, Geneva, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        h1 {
            background-color: #333;
            color: #fff;
            padding: 10px;
            text-align: center;
        }

        #player-list,
        #chat {
            margin: 20px;
            padding: 10px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        #chat {
            margin-top: 20px;
        }

        .player,
        .chat-message {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .player {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kick-button {
            padding: 5px 10px;
            background-color: #ff4d4d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .kick-button:hover {
            background-color: #e60000;
        }

        #chat-messages {
            max-height: 200px;
            overflow-y: auto;
        }

        #chat-input {
            display: flex;
            margin-top: 10px;
        }

        #chat-input input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-right: 10px;
        }

        #chat-input button {
            padding: 10px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #chat-input button:hover {
            background-color: #45a049;
        }
    </style>
    <script src="https://unpkg.com/colyseus.js@^0.15.0/dist/colyseus.js"></script>
</head>

<body>
    <h1>Multiplayer Game - Players List & Chat</h1>
    <div id="player-list">
        <strong>Connected Players:</strong>
        <div id="players"></div>
    </div>
    <div id="chat">
        <strong>Chat:</strong>
        <div id="chat-messages"></div>
        <div id="chat-input">
            <input type="text" id="message-input" placeholder="Type your message..." />
            <button id="send-button">Send</button>
        </div>
    </div>
    <script>
        const host = window.document.location.host.replace(/:.*/, '');
        const client = new Colyseus.Client(
            location.protocol.replace('http', 'ws') +
            '//' +
            host +
            (location.port ? ':' + location.port : '')
        );

        const playersContainer = document.getElementById('players');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        client.joinOrCreate("Room_handler", { role: "observer" }).then((room) => {
            const players = {};

            function addPlayerUI(sessionId, player) {
                const playerElement = document.createElement('div');
                playerElement.className = 'player';
                playerElement.id = `player-${sessionId}`;

                const playerInfo = document.createElement('div');
                playerInfo.className = 'player-info';
                updatePlayerUI(playerInfo, player);

                const kickButton = document.createElement('button');
                kickButton.className = 'kick-button';
                kickButton.textContent = 'Kick';
                kickButton.onclick = () => {
                    room.send("kick", { sessionId });
                };

                playerElement.appendChild(playerInfo);
                playerElement.appendChild(kickButton);
                playersContainer.appendChild(playerElement);
            }

            function updatePlayerUI(element, player) {
                element.innerHTML = `
                    <strong>${player.name || "Unnamed Player"}</strong><br />
                    Position: x: ${player.position.x.toFixed(2)}, y: ${player.position.y.toFixed(2)}, z: ${player.position.z.toFixed(2)}<br />
                    Rotation: x: ${player.rotation.x.toFixed(2)}, y: ${player.rotation.y.toFixed(2)}, z: ${player.rotation.z.toFixed(2)}
                `;
            }

            function removePlayerUI(sessionId) {
                const playerElement = document.getElementById(`player-${sessionId}`);
                if (playerElement) {
                    playersContainer.removeChild(playerElement);
                }
            }

            // Handle state updates for players
            room.state.players.onAdd(function (player, sessionId) {
                console.log('player: ', player);
                players[sessionId] = player;
                addPlayerUI(sessionId, player);

                player.position.onChange(function () {
                    const playerElement = document.getElementById(`player-${sessionId}`).querySelector('.player-info');
                    if (playerElement) {
                        updatePlayerUI(playerElement, player);
                    }
                });

                player.rotation.onChange(function () {
                    const playerElement = document.getElementById(`player-${sessionId}`).querySelector('.player-info');
                    if (playerElement) {
                        updatePlayerUI(playerElement, player);
                    }
                });
            });

            room.state.players.onRemove(function (player, sessionId) {
                delete players[sessionId];
                removePlayerUI(sessionId);
            });

            // Chat functionality
            sendButton.addEventListener('click', () => {
                const message = messageInput.value.trim();
                if (message) {
                    room.send("message", { sender: "observer", message: message });
                    const chatMessage = document.createElement('div');
                    chatMessage.className = 'chat-message';
                    chatMessage.textContent = `you : ${message}`;
                    chatMessages.appendChild(chatMessage);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    messageInput.value = '';
                }
            });

            room.onMessage("chat", (data) => {
                const chatMessage = document.createElement('div');
                chatMessage.className = 'chat-message';
                chatMessage.textContent = `${data.sender}: ${data.message}`;
                chatMessages.appendChild(chatMessage);

                // Scroll to the bottom of the chat
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        });
    </script>


</body>

</html>